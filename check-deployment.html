<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deployment Check</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Deployment Investigation Tool</h1>
    
    <div class="debug-section">
        <h2>Database Structure Investigation</h2>
        <p>This tool will help investigate where the 5 fake fixtures are coming from.</p>
        
        <button onclick="checkOldFixturesStructure()">üîç Check Old Fixtures Structure</button>
        <button onclick="checkNewFixturesStructure()">üîç Check New Fixtures Structure</button>
        <button onclick="checkAllCollections()">üîç Check All Collections</button>
        <button onclick="cleanupOldStructure()">üßπ Clean Up Old Structure</button>
        
        <div id="results"></div>
    </div>

    <script>
        // Wait for Firebase to be ready
        function waitForFirebase() {
            if (window.firebaseReady && window.firebaseDB) {
                console.log('‚úÖ Firebase ready, starting investigation...');
                return true;
            } else {
                console.log('‚è≥ Waiting for Firebase...');
                setTimeout(waitForFirebase, 1000);
                return false;
            }
        }

        async function checkOldFixturesStructure() {
            if (!waitForFirebase()) return;
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h3>üîç Checking Old Fixtures Structure...</h3>';
            
            try {
                const db = window.firebaseDB;
                
                // Check the old fixtures collection
                const oldFixturesSnapshot = await db.collection('fixtures').get();
                
                let html = '<h3>üìã Old Fixtures Collection Results:</h3>';
                
                if (oldFixturesSnapshot.empty) {
                    html += '<p class="success">‚úÖ Old fixtures collection is empty - no fake fixtures found here</p>';
                } else {
                    html += `<p class="warning">‚ö†Ô∏è Found ${oldFixturesSnapshot.size} documents in old fixtures collection:</p>`;
                    
                    oldFixturesSnapshot.forEach(doc => {
                        const data = doc.data();
                        html += `<div style="margin: 10px 0; padding: 10px; background: white; border-left: 4px solid #ffc107;">`;
                        html += `<strong>Document ID:</strong> ${doc.id}<br>`;
                        html += `<strong>Data:</strong> <pre>${JSON.stringify(data, null, 2)}</pre>`;
                        html += `</div>`;
                    });
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">‚ùå Error checking old fixtures: ${error.message}</p>`;
                console.error('Error checking old fixtures:', error);
            }
        }

        async function checkNewFixturesStructure() {
            if (!waitForFirebase()) return;
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h3>üîç Checking New Fixtures Structure...</h3>';
            
            try {
                const db = window.firebaseDB;
                
                // Check the new multi-club structure
                const clubsSnapshot = await db.collection('clubs').get();
                
                let html = '<h3>üèÜ New Multi-Club Structure Results:</h3>';
                
                if (clubsSnapshot.empty) {
                    html += '<p class="warning">‚ö†Ô∏è No clubs found in new structure</p>';
                } else {
                    html += `<p class="success">‚úÖ Found ${clubsSnapshot.size} clubs in new structure:</p>`;
                    
                    for (const clubDoc of clubsSnapshot.docs) {
                        const clubId = clubDoc.id;
                        html += `<div style="margin: 10px 0; padding: 10px; background: white; border-left: 4px solid #28a745;">`;
                        html += `<strong>Club ID:</strong> ${clubId}<br>`;
                        
                        // Check editions
                        const editionsSnapshot = await db.collection('clubs').doc(clubId).collection('editions').get();
                        if (!editionsSnapshot.empty) {
                            html += `<strong>Editions:</strong> ${editionsSnapshot.size}<br>`;
                            
                            for (const editionDoc of editionsSnapshot.docs) {
                                const editionId = editionDoc.id;
                                html += `&nbsp;&nbsp;‚Ä¢ ${editionId}<br>`;
                                
                                // Check fixtures for this edition
                                const fixturesSnapshot = await db.collection('clubs').doc(clubId)
                                    .collection('editions').doc(editionId)
                                    .collection('fixtures').get();
                                
                                if (!fixturesSnapshot.empty) {
                                    html += `&nbsp;&nbsp;&nbsp;&nbsp;üìã Fixtures: ${fixturesSnapshot.size} gameweeks<br>`;
                                    
                                    fixturesSnapshot.forEach(fixtureDoc => {
                                        const fixtureData = fixtureDoc.data();
                                        html += `&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Ä¢ ${fixtureDoc.id}: ${fixtureData.fixtures ? fixtureData.fixtures.length : 0} fixtures<br>`;
                                    });
                                } else {
                                    html += `&nbsp;&nbsp;&nbsp;&nbsp;üìã No fixtures found<br>`;
                                }
                            }
                        } else {
                            html += `<strong>Editions:</strong> None found<br>`;
                        }
                        
                        html += `</div>`;
                    }
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">‚ùå Error checking new structure: ${error.message}</p>`;
                console.error('Error checking new structure:', error);
            }
        }

        async function checkAllCollections() {
            if (!waitForFirebase()) return;
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h3>üîç Checking All Collections...</h3>';
            
            try {
                const db = window.firebaseDB;
                
                // Get all root collections
                const collections = await db.listCollections();
                
                let html = '<h3>üìö All Root Collections:</h3>';
                
                for (const collection of collections) {
                    const collectionName = collection.id;
                    html += `<div style="margin: 10px 0; padding: 10px; background: white; border-left: 4px solid #6c757d;">`;
                    html += `<strong>Collection:</strong> ${collectionName}<br>`;
                    
                    // Get document count
                    const snapshot = await db.collection(collectionName).get();
                    html += `<strong>Documents:</strong> ${snapshot.size}<br>`;
                    
                    // Show first few document IDs
                    if (!snapshot.empty) {
                        html += `<strong>Sample Document IDs:</strong><br>`;
                        snapshot.docs.slice(0, 5).forEach(doc => {
                            html += `&nbsp;&nbsp;‚Ä¢ ${doc.id}<br>`;
                        });
                        if (snapshot.size > 5) {
                            html += `&nbsp;&nbsp;... and ${snapshot.size - 5} more<br>`;
                        }
                    }
                    
                    html += `</div>`;
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">‚ùå Error checking collections: ${error.message}</p>`;
                console.error('Error checking collections:', error);
            }
        }

        async function cleanupOldStructure() {
            if (!waitForFirebase()) return;
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h3>üßπ Cleaning Up Old Structure...</h3>';
            
            try {
                const db = window.firebaseDB;
                
                // Delete the old fixtures collection entirely
                const oldFixturesSnapshot = await db.collection('fixtures').get();
                
                if (oldFixturesSnapshot.empty) {
                    resultsDiv.innerHTML = '<p class="success">‚úÖ Old fixtures collection is already empty</p>';
                    return;
                }
                
                // Delete all documents in the old fixtures collection
                const batch = db.batch();
                oldFixturesSnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                resultsDiv.innerHTML = `<p class="success">‚úÖ Successfully deleted ${oldFixturesSnapshot.size} documents from old fixtures collection</p>`;
                
                // Also check for other old collections that might contain fixtures
                const oldCollections = ['users', 'picks', 'settings'];
                
                for (const collectionName of oldCollections) {
                    try {
                        const snapshot = await db.collection(collectionName).get();
                        if (!snapshot.empty) {
                            resultsDiv.innerHTML += `<p class="warning">‚ö†Ô∏è Found ${snapshot.size} documents in old ${collectionName} collection</p>`;
                        }
                    } catch (error) {
                        // Collection might not exist, ignore
                    }
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">‚ùå Error cleaning up old structure: ${error.message}</p>`;
                console.error('Error cleaning up old structure:', error);
            }
        }

        // Auto-start when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîç Deployment investigation tool loaded');
            if (waitForFirebase()) {
                console.log('‚úÖ Firebase already ready');
            }
        });
    </script>
</body>
</html>
